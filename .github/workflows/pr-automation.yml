name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          echo "ESLINT_OUTPUT=$(npm run lint 2>&1 | head -200)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run Prettier check
        id: prettier
        run: |
          echo "PRETTIER_OUTPUT=$(npx prettier --check src/ 2>&1 | head -200)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Post Code Quality Report
        uses: actions/github-script@v7
        with:
          script: |
            const eslint = '${{ steps.eslint.outputs.ESLINT_OUTPUT }}';
            const prettier = '${{ steps.prettier.outputs.PRETTIER_OUTPUT }}';
            const success = !eslint.includes('error') && !prettier.includes('error');
            const header = success ? '✅ **Code Quality Report** - All checks passed!' : '❌ **Code Quality Report** - Issues found';
            const body = `
${header}

### ESLint
\`\`\`
${eslint || 'No issues found'}
\`\`\`

### Prettier
\`\`\`
${prettier || 'No issues found'}
\`\`\`

`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  testing-suite:
    name: Testing Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: test
        run: |
          npm run test:coverage 2>&1 | tee test-output.txt
          echo "TEST_OUTPUT=$(head -200 test-output.txt)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Extract coverage summary
        id: coverage
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const cov = require('./coverage/coverage-summary.json'); console.log(JSON.stringify(cov.total, null, 2))")
            echo "COVERAGE_SUMMARY=${COVERAGE}" >> $GITHUB_OUTPUT
          else
            echo "COVERAGE_SUMMARY={\"error\": \"Coverage file not found\"}" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        with:
          script: |
            const testOutput = '${{ steps.test.outputs.TEST_OUTPUT }}';
            const coverageSummary = '${{ steps.coverage.outputs.COVERAGE_SUMMARY }}';
            const passed = !testOutput.includes('FAIL') && !testOutput.includes('Test Suites: 0 passed');
            const header = passed ? '✅ **Test Coverage Report** - All tests passed!' : '❌ **Test Coverage Report** - Test failures';
            let coverageData;
            try {
              coverageData = JSON.parse(coverageSummary);
            } catch {
              coverageData = { error: 'Could not parse coverage data' };
            }
            const body = `
${header}

### Test Results
\`\`\`
${testOutput || 'No test output'}
\`\`\`

### Coverage Summary
\`\`\`json
${JSON.stringify(coverageData, null, 2)}
\`\`\`

`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "AUDIT_OUTPUT=$(npm audit --json 2>&1 | head -2000)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run secret scanning with Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          no-git: false
          redact: true
        continue-on-error: true

      - name: Post Security Scan Report
        uses: actions/github-script@v7
        with:
          script: |
            const auditRaw = '${{ steps.npm-audit.outputs.AUDIT_OUTPUT }}';
            let auditResult = 'No vulnerabilities found';
            try {
              const auditJson = JSON.parse(auditRaw);
              if (auditJson.metadata && auditJson.metadata.vulnerabilities) {
                const vuln = auditJson.metadata.vulnerabilities;
                auditResult = `Total: ${vuln.total} (${vuln.low} low, ${vuln.moderate} moderate, ${vuln.high} high, ${vuln.critical} critical)`;
              }
            } catch {
              auditResult = auditRaw || 'Could not parse audit output';
            }
            const gitleaksResult = '${{ steps.gitleaks.outputs.GITLEAKS_RESULT }}' || 'No secrets found';
            const body = `
### Security Scan Report

#### Dependency Vulnerabilities
${auditResult}

#### Secret Scanning
${gitleaksResult}

`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: |
          echo "BUILD_OUTPUT=$(npm run build 2>&1)" >> $GITHUB_OUTPUT

      - name: Start application in background
        run: |
          npm start &
          sleep 5

      - name: Validate endpoints
        id: validate
        run: |
          curl -f http://localhost:3000/health 2>&1 | head -50
          echo "HEALTH_CHECK_OUTPUT=$?" >> $GITHUB_OUTPUT

      - name: Create deployment preview artifacts
        run: |
          mkdir -p deployment-preview
          cp -r src/* deployment-preview/
          cp package.json deployment-preview/
          cp package-lock.json deployment-preview/
          echo "Preview artifacts ready"

      - name: Upload preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview
          path: deployment-preview/

      - name: Post Build Validation Report
        uses: actions/github-script@v7
        with:
          script: |
            const buildOutput = '${{ steps.build.outputs.BUILD_OUTPUT }}';
            const healthCheck = '${{ steps.validate.outputs.HEALTH_CHECK_OUTPUT }}';
            const healthSuccess = healthCheck === '0';
            const header = healthSuccess ? '✅ **Build Validation** - Build succeeded and endpoints are accessible' : '❌ **Build Validation** - Build or health check failed';
            const body = `
${header}

### Build Output
\`\`\`
${buildOutput || 'No build output'}
\`\`\`

### Health Check
Health endpoint ${healthSuccess ? '✅ accessible' : '❌ failed'}

`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });